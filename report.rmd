---
title: "Lorauna Report"
author: "Janik von Rotz"
date: "4/16/2019"
output: html_document
---

```{r libaries, include=FALSE}
library('rjson')
library('mongolite')
library('magrittr')
library('dplyr')
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# load config files
readRenviron(".env")
```

This document provides insight about data gathered by the lorauna app. During the 2018/2019 sauna season the entrering and exiting visitors have been continiously logged by the on-premise receptionist This log entries are now used to analyze the seasons performance.

# Data

The dataset to create this report is pulled directly from the lorauna database and has been prepared in the following manner:

```{r data}
# setup connection
connection <- mongo(collection = "visitor", db = "lorauna", url = Sys.getenv("MONGO_URL"))

# read and filter visitors data
visitors <- connection$find(
  query = '{
    "created": { "$gte" : { "$date" : "2019-01-01T00:00:00Z" }},
    "created": { "$lte" : { "$date" : "2019-02-31T00:00:00Z" }}
  }'
)

# add date column
visitors$date <- as.Date(visitors$created)

# add day column
visitors$day <- format(visitors$date, '%d')

# add week day column
visitors$weekday <- weekdays(as.Date(visitors$date))

# add month column
visitors$month <- months(as.Date(visitors$date))

# filter weekdays
visitors <- visitors %>% filter(weekday %in% c('Monday', 'Tuesday', 'Friday', 'Saturday', 'Sunday'))

# define weekday factors for sorting
visitors$weekday <- factor(visitors$weekday, levels= c("Monday", 
    "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"))

# filter incoming visitors
visitors_in <- visitors %>% filter(value == 1)
```

Summary of the dataset:

```{r summary}
summary(visitors_in)
```

# Summary by Month

In the following chapters you will find relevant data and a verdict for each month.

```{r, include=FALSE}
filter_month <- 'January'
```

## `r month`

```{r, include=FALSE}
# filter visitors by month
visitors_filtered <- visitors_in %>% filter(month == filter_month)

# calculate count of visitors for this month
visitors_count <- sum(visitors_filtered$value)
```

In `r filter_month` there were `r visitors_count` visitors.

The following bar plot shows the average distribution by weekday:

```{r, include=FALSE}
# get count of visitors by date and weekday
visitors_by_weekday <- aggregate(visitors_in['value'], by=list(date=visitors_in$date, weekday=visitors_in$weekday), FUN=sum)

# calculate average by weekday
visitors_by_weekday <- aggregate(visitors_by_weekday['value'], by=visitors_by_weekday['weekday'], FUN=mean)

# sort visitors
visitors_by_weekday <- visitors_by_weekday[order(visitors_by_weekday$weekday),]
```

```{r, echo=FALSE}
barplot(visitors_by_weekday$value, names.arg=visitors_by_weekday$weekday)
```
```{r, include=FALSE}
filter_month <- 'February'
```

## `r month`

```{r, include=FALSE}
# filter visitors by month
visitors_filtered <- visitors_in %>% filter(month == filter_month)

# calculate count of visitors for this month
visitors_count <- sum(visitors_filtered$value)
```

In `r filter_month` there were `r visitors_count` visitors.

The following bar plot shows the average distribution by weekday:

```{r, include=FALSE}
# get count of visitors by date and weekday
visitors_by_weekday <- aggregate(visitors_in['value'], by=list(date=visitors_in$date, weekday=visitors_in$weekday), FUN=sum)

# calculate average by weekday
visitors_by_weekday <- aggregate(visitors_by_weekday['value'], by=visitors_by_weekday['weekday'], FUN=mean)

# sort visitors
visitors_by_weekday <- visitors_by_weekday[order(visitors_by_weekday$weekday),]
```

```{r, echo=FALSE}
barplot(visitors_by_weekday$value, names.arg=visitors_by_weekday$weekday)
```
